{% extends "base.html" %}

{% block styles %}
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-side-modals.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/leaflet.awesome-markers.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
{% endblock %}

{% block title %}{{ _("WLM Brasil") }}{% endblock %}

{#{% block navbar %}#}
{#    {% with lang=lang, username=username, mapa_geral=True, mapa=False, geolocate=True, uf=uf, suggest=True %}#}
{#        {% include 'topnavbar.html' %}#}
{#    {% endwith %}#}
{#{% endblock %}#}

{% block banner %}{% endblock %}
{% block content %}
    <div class="w3-row" style="height:100%">
        <div class="w3-container" style="height:100vh; padding:0">
            <div id="map"></div>
            <div class="modal modal-left fade" id="presentationModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog" role="document" >
                    <div class="modal-content"style="background-color: rgba(255,255,255,0.85);">
                        <div class="modal-header">
                            <h2 class="modal-title" id="selectedState">{{ _("Seja bem-vindo(a/e)!") }}</h2>
                            <button type="button" class="close custom" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>{{ _("Olá, gostaríamos de te dar as boas-vindas!") }}</p>
                            <p>{{ _("O <b>Wiki Loves Brasil</b> é um aplicativo de envio de imagens para a etapa nacional do maior concurso fotográfico do mundo, o <b><i>Wiki Loves Monuments</i></b>!") }}</p>
                            <p>{{ _("Envie suas fotografias do patrimônio histórico brasileiro durante o mês de setembro para participar e concorrer a prêmios.") }}</p>
                            <hr>
                            <p>{{ _("Comece selecionando uma subdivisão no mapa para ver os monumentos da região.") }}</p>
                            <hr>
                            <a target="_blank" href="{{ _('https://pt.wikipedia.org/wiki/Wikipédia:Wiki_Loves_Monuments/Brasil') }}">
                                <button class="custom" style="color:black; padding:10px; width:100%; background-color: #cdcdcd; margin-bottom: 1rem">
                                    <img src="{{ url_for('static', filename='/images/logowikipedia.png') }}" width="25px" alt="{{ _('Logotipo') }}">
                                    {{ _("Visite a página do concurso na Wiki") }}
                                </button>
                            </a>
                            <a target="_blank" href="{{ url_for('about') }}">
                                <button class="custom" style="padding:10px; width:100%; background-color: #990000; margin-bottom: 1rem">
                                    <i class="fas fa-info-circle"></i>
                                    {{ _("Saiba mais sobre este aplicativo") }}
                                </button>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal modal-left fade" id="langModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog" role="document" >
                    <div class="modal-content" style="background-color: rgba(255,255,255,0.85);">
                        <div class="modal-header">
                            <h2 class="modal-title" id="selectedState">{{ _("Selecione um idioma") }}</h2>
                            <button type="button" class="close custom" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <ul style="line-height: 200%">
                                {% for language in AVAILABLE_LANGUAGES %}
                                    <li>
                                        <a tabindex="0" href="{{url_for('set_locale', return_to=request.script_root + request.full_path, lang=language)}}">
                                            {{ language|upper }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal modal-left fade" id="aboutModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog" role="document" >
                <div class="modal-content" style="background-color: rgba(255,255,255,0.85);">
                    <div class="modal-header">
                        <h2 class="modal-title" id="about">{{ _("Sobre") }}</h2>
                        <button type="button" class="close custom" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>
                            {{ _("Você está pronto(a) para participar do maior concurso fotográfico do mundo?! O aplicativo <b>Wiki Loves Brasil</b> te oferece diversas formas de participar: Enviando suas fotografias dos monumentos brasileiros de maneira simplificada, geolocalizar monumentos ainda sem coordenadas registradas e sugerir monumentos que por acaso não estejam nas listas.") }}<br><br>
                            {{ _("O Wiki Loves Monuments é o maior concurso fotográfico do mundo! A etapa nacional ocorre entre 1º e 30 de setembro de 2022.") }}<br><br>
                            {{ _("No ano de 2021, o Brasil foi o vencedor da etapa internacional, com a imagem <a target='_blank' href='https://commons.wikimedia.org/wiki/File:Real_Gabinete_Português_de_Leitura_10.jpg' title='Real Gabinete Português de Leitura, por Donatas Dabravolskas'>Real Gabinete Português de Leitura</a>, por Donatas Dabravolskas.") }}<br><br>
                            {{ _("Participe e concorra a prêmios. Mais detalhes na <a target='_blank' href='https://w.wiki/5Bkv' title='Wiki Loves Monuments Brasil 2022'>página do concurso na Wikipédia</a>.") }}
                        </p>
                        <hr>
                        <p>
                            {% set flask %}<a target='_blank' href='https://pt.wikipedia.org/wiki/Flask_(framework_web)'><i>{{ _("Flask") }}</i></a>{% endset %}
                            {% set github %}<a target='_blank' href='https://github.com/WikiMovimentoBrasil/wikilovesbrasil'>{{ _("GitHub") }}</a>{% endset %}
                            {% set license_code %}<a target='_blank' href='https://github.com/WikiMovimentoBrasil/wikilovesbrasil/blob/master/LICENSE'>{{ _("GPL v3.0") }}</a>{% endset %}
                            {% set license_text %}<a target='_blank' href='https://creativecommons.org/licenses/by-sa/4.0/'>{{ _("CC-BY-SA 4.0 Internacional") }}</a>{% endset %}
                            {% set license_maps %}<a target='_blank' href='https://opendatacommons.org/licenses/odbl/1-0/'>{{ _("ODbL v1.0") }}</a>{% endset %}
                            {% set license_wikidata %}<a target='_blank' href='https://creativecommons.org/share-your-work/public-domain/cc0/'>{{ _("CC0") }}</a>{% endset %}
                            {% set reference %}<a target='_blank' href='https://maps.wikilovesmonuments.org'>{{ _("Wiki Loves Monuments Map") }}</a>{% endset %}
                            <small>
                                {{ _("Este aplicativo é inspirado no %(reference)s, desenvolvido por Paweł Marynowski e Stephen LaPorte", reference=reference) }}<br>
                                {{ _("Este aplicativo foi desenvolvido em %(flask)s.", flask=flask) }}<br>
                                {{ _("O código-fonte está disponível no %(github)s.", github=github) }}<br>
                                {{ _("Licença do cógido-fonte: %(license_code)s.", license_code=license_code) }}<br>
                                {{ _("Licença de textos: %(license_text)s.", license_text=license_text) }}<br>
                                {{ _("Licença de mapas: %(license_maps)s.", license_maps=license_maps) }}<br>
                                {{ _("Licença dos metadados retornados do Wikidata: %(license_wikidata)s.", license_wikidata=license_wikidata) }}<br>
                                {{ _("Versão 1.0.") }}
                            </small>
                        </p>
                    </div>
    {#                <div class="modal-footer">#}
    {#                </div>#}
                </div>
            </div>
            </div>
            <div class="modal modal-left fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="selectedState" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="filter_title">{{ _("Filtrar") }}</h5>
                            <button type="button" class="close custom" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body w3-container" id ="filter_content" style="font-family: 'Josefin Sans', 'FontAwesome', 'Font Awesome 6 Free', sans-serif">
                            <form>
                                <div class="w3-container w3-third">
                                    <div class="form-group">
                                        <label for="has_image">{{ _("Monumentos com ou sem imagens?") }}</label>
                                        <select id="has_image" class="form-control">
                                            <option value="all" selected>{{ _("Ambos") }}</option>
                                            <option value="yes">{{ _("Com") }}</option>
                                            <option value="no">{{ _("Sem") }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="w3-container w3-third">
                                    <div class="form-group">
                                        <label for="types">{{ _("Tipos de imagem:") }}</label>
                                        <select id="types" class="form-control" disabled>
                                            <option value="all">{{ _("Todos") }}</option>
                                            <option value="P18" title="{{ _('Não tenho certeza') }}">{{ _('Selecione o tipo de imagem (opcional)') }}</option>
                                            <option value="P18" title="{{ _('Imagem ilustrativa do monumento') }}">&#xf03e; {{ _('Imagem do exterior/Imagem ilustrativa') }}</option>
                                            <option value="P5775" title="{{ _('Vista do interior de um edifício ou espaço fechado') }}">&#xf52b; {{ _('Imagem do interior') }}</option>
                                            <option value="P9721" title="{{ _('Vista da entrada de um edifício ou espaço fechado, vista do lado de fora') }}">&#xf6d9; {{ _('Imagem da entrada') }}</option>
                                            <option value="P9906" title="{{ _('Imagem de inscrições no monumento') }}">&#xf022; {{ _('Imagem da inscrição') }}</option>
                                            <option value="P1801" title="{{ _('Imagem de placa de inauguração ou inscrição mencionando o monumento') }}">&#xf5a2; {{ _('Placa comemorativa') }}</option>
                                            <option value="P1766" title="{{ _('Imagem de placa de trânsito com nome de local') }}">&#xf277; {{ _('Placa com o nome do lugar') }}</option>
                                            <option value="P8592" title="{{ _('Fotografia de um monumento tirada do ar, por um drone, por exemplo') }}">&#xf533; {{ _('Vista aérea') }}</option>
                                            <option value="P3451" title="{{ _('Monumento ao entardecer ou à noite') }}">&#xf186; {{ _('Vista noturna') }}</option>
                                            <option value="P4291" title="{{ _('Ampla vista geral que contém o monumento') }}">&#xe209; {{ _('Vista panorâmica') }}</option>
                                            <option value="P5252" title="{{ _('Imagem do monumento no inverno, de preferência com neve') }}">&#xf2dc; {{ _('Vista no inverno') }}</option>
                                            <option value="P8517" title="{{ _('Vista a partir do monumento') }}">&#xe52f; {{ _('Vista') }}</option>
                                            <option value="P4640" title="{{ _('Imagem com campo de visão de 360 por 180 graus') }}">&#xf433; {{ _('Fotoesfera') }}</option>
                                            <option value="P3311" title="{{ _('Imagem representando a planta de um edifício ou local') }}">&#xf546; {{ _('Imagem da planta') }}</option>
                                            <option value="P1442" title="{{ _('Imagem de um túmulo, lápide ou jazigo') }}">&#xf654; {{ _('Imagem do túmulo') }}</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="custom btn btn-secondary" data-dismiss="modal">{{ _("Cancelar") }}</button>
                            <button id="filter" type="button" class="custom btn btn-primary" data-dismiss="modal">{{ _("Filtrar") }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="{{ url_for('static', filename='js/leaflet.awesome-markers.js') }}"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster.freezable@1.0.0/dist/leaflet.markercluster.freezable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        const bounds = {{ bounds | safe }};
        const filterTooltip = "{{ _('Filtre os monumentos') }}";
        const selectTooltip = "{{ _('Selecione os monumentos') }}";
        const unselectTooltip = "{{ _('Limpar seleção') }}";
        const credits_osm = '&copy; <a href="https://openstreetmap.org/copyright">{{ _("Contribuidores do OpenStreetMap") }}</a>';
        const credits_wikimedia = '<a href="https://foundation.wikimedia.org/wiki/Maps_Terms_of_Use">{{ _("Mapas da Wikimedia") }}</a> | ' + credits_osm;

        // Map layer
        var map = L.map('map', {zoomControl:false}).setMaxBounds([[10, -20], [-40, -90]]);

        var osm_map = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            minZoom: 4,
            attribution: '&copy; <a href="https://openstreetmap.org/copyright">{{ _("Contribuidores do OpenStreetMap") }}</a>'
        }).addTo(map);

        const wm_map = L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png', {
            maxZoom: 7,
            minZoom: 4,
            attribution: credits_wikimedia
        });

        // Icons
        var greenIcon = L.AwesomeMarkers.icon({
            icon: 'fa-solid fa-image',
            markerColor: 'green',
            iconColor: 'white',
            prefix: 'fas'
        });

        var greenblueIcon = L.AwesomeMarkers.icon({
            icon: 'fa-solid fa-image',
            markerColor: 'darkblue',
            iconColor: 'white',
            prefix: 'fas'
        });

        var redIcon = L.AwesomeMarkers.icon({
            icon: 'fa-camera',
            markerColor: 'red',
            iconColor: 'white',
            prefix: 'fa'
        });

        var redblueIcon = L.AwesomeMarkers.icon({
            icon: 'fa-camera',
            markerColor: 'darkblue',
            iconColor: 'white',
            prefix: 'fa'
        });

        // Markers cluster
        var markers_with_image = L.markerClusterGroup({
            maxClusterRadius: 100,
            disableClusteringAtZoom: 15,
            showCoverageOnHover: false,
            iconCreateFunction: function (cluster) {
                var markers = cluster.getAllChildMarkers();
                if (markers.length < 10) {
                    return L.divIcon({
                        html: '<div class="green-cluster green-circle-tiny">' + markers.length + '</div>',
                        iconSize: L.point(20, 20)
                    });
                } else if (markers.length < 25) {
                    return L.divIcon({
                        html: '<div class="green-cluster green-circle-small">' + markers.length + '</div>',
                        iconSize: L.point(25, 25)
                    });
                } else if (markers.length < 50) {
                    return L.divIcon({
                        html: '<div class="green-cluster green-circle-normal">' + markers.length + '</div>',
                        iconSize: L.point(30, 30)
                    });
                } else if (markers.length < 250) {
                    return L.divIcon({
                        html: '<div class="green-cluster green-circle-big">' + markers.length + '</div>',
                        iconSize: L.point(35, 35)
                    });
                } else {
                    return L.divIcon({
                        html: '<div class="green-cluster green-circle-large">' + markers.length + '</div>',
                        iconSize: L.point(40, 40)
                    });
                }
            }
        });

        var markers_without_image = L.markerClusterGroup({
            maxClusterRadius: 100,
            disableClusteringAtZoom: 15,
            showCoverageOnHover: false,
            iconCreateFunction: function (cluster) {
                var markers = cluster.getAllChildMarkers();
                if (markers.length < 10) {
                    return L.divIcon({
                        html: '<div class="red-cluster red-circle-tiny">' + markers.length + '</div>',
                        iconSize: L.point(20, 20)
                    });
                } else if (markers.length < 25) {
                    return L.divIcon({
                        html: '<div class="red-cluster red-circle-small">' + markers.length + '</div>',
                        iconSize: L.point(25, 25)
                    });
                } else if (markers.length < 50) {
                    return L.divIcon({
                        html: '<div class="red-cluster red-circle-normal">' + markers.length + '</div>',
                        iconSize: L.point(30, 30)
                    });
                } else if (markers.length < 250) {
                    return L.divIcon({
                        html: '<div class="red-cluster red-circle-big">' + markers.length + '</div>',
                        iconSize: L.point(35, 35)
                    });
                } else {
                    return L.divIcon({
                        html: '<div class="red-cluster red-circle-large">' + markers.length + '</div>',
                        iconSize: L.point(40, 40)
                    });
                }
            }
        });

        var toggle_com_imagens = false;
        var toggle_sem_imagens = false;
        var toggle_select = false;

        // Adding elements to the map
        markers_with_image.addTo(map);

        markers_without_image.addTo(map);

        var markers_selected = L.featureGroup.subGroup();

        // Making map fit to the state
        map.fitBounds(bounds);

        // Buttons
        // Zoom
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Locate
        var locate = L.control.locate({
            flyTo: true,
            position: 'bottomright',
            returnToPrevBounds: true,
            icon: 'locate fa-solid fa-location-dot',
            iconElementTag: 'i',
            strings: {
                title: "{{_('Mostre-me onde estou')}}"
            },
        }).addTo(map);

        // Layers
        L.control.layers({"OpenStreetMap": osm_map, "Wikimedia": wm_map}, null,{position: 'bottomright'}).addTo(map);

        // Logo at bottom left
        L.Control.Watermark = L.Control.extend({
            onAdd: function(map) {
                var img = L.DomUtil.create('img');
                img.src = "{{ url_for('static', filename='/images/logo - pt.svg') }}";
                img.style.width = '108px';
                img.style.marginBottom = '26px';
                return img;
            }
        });
        L.control.watermark = function(opts) { return new L.Control.Watermark(opts); }
        L.control.watermark({ position: 'bottomleft' }).addTo(map);

        // Menu
        const menuButton = L.easyButton({
            states:[{
                icon: "<i class='fa-solid fa-bars'></i> ",
                stateName: 'menu',
                onClick: function(){ $('#presentationModal').modal('show'); }}]}).addTo(map);


        // HOME
        const homeButton = L.easyButton(
            "<i class='fa-solid fa-house'></i>",
            function(){ window.open("{{ url_for('mapa') }}", '_self');},
            '{{ _("Voltar para o mapa principal") }}'
        ).addTo(map);

        // LANGUAGE
        const langButton = L.easyButton(
            "<i class='fa-solid fa-language'></i>",
            function(){ $('#langModal').modal('show'); },
            '{{ _("Mudar de idioma") }}'
        ).addTo(map);

        // GROUP/UNGROUP
        var groupButton = L.easyButton({
            states:[
                {
                    icon: "<i class='fa-solid fa-object-ungroup'></i> " + "{{ _('Desagrupar') }}",
                    stateName: 'grouped',
                    width: '100%',
                    title: '{{ _("Desagrupar monumentos") }}',
                    onClick: function(btn, map){
                        btn.state('ungrouped');
                        markers_with_image.freezeAtZoom("max");
                        markers_without_image.freezeAtZoom("max");
                    }
                },
                {
                    icon: "<i class='fa-solid fa-object-group'></i> " + "{{ _('Agrupar') }}",
                    stateName: 'ungrouped',
                    width: '100%',
                    title: '{{ _("Agrupar monumentos") }}',
                    onClick: function(btn){
                        btn.state('grouped');
                        markers_with_image.freezeAtZoom(false);
                        markers_without_image.freezeAtZoom(false);
                    }
                }
            ]}).addTo(map);

        // FILTER
        let has_image_filtered = "all",
            types_filtered = "all";

        let filterButton = L.easyButton({
            states:[
                {
                    icon: "<i class='fa-solid fa-filter'></i> " + "{{ _('Filtrar') }}",
                    stateName: 'filter',
                    width: '100%',
                    title: filterTooltip,
                    onClick: function(btn, map){
                        $('#has_image').val(has_image_filtered);
                        $('#types').val(types_filtered);
                        $('#filterModal').modal('show');
                    }
                }]}).addTo(map);

        const printButton = L.easyPrint({
            title: '{{ _("Imprimir mapa") }}',
            position: 'topleft',
            sizeModes: ['A4Portrait', 'A4Landscape'],
            defaultSizeTitles: {A4Landscape: '{{ _("Paisagem") }}', A4Portrait: '{{ _("Retrato") }}'}
        }).addTo(map);

        const infoButton = L.easyButton(
            '<i class="fa-solid fa-info"></i>',
            function() { $('#aboutModal').modal('show'); },
            '{{ _("Informações sobre o aplicativo") }}'
        ).addTo(map);

        var saveSelectButton = L.easyButton({
            states:[
                {
                    icon: "<i class='fa-solid fa-download'></i> " + "{{ _('Salvar seleção') }}",
                    stateName: 'saveselect',
                    width: '100%',
                    display: 'none',
                    title: selectTooltip,
                    onClick: function(btn, map){
                        let selectedMarkers = [];
                        markers_selected.getLayers().forEach(function (marker) {
                            const match = marker.getPopup().getContent().match(/.*(Q\d+).*/);
                            selectedMarkers.push(match[1]);
                        });
                        $.ajax({
                                url: "/print_selection",
                                type: "POST",
                                data: JSON.stringify({"items":selectedMarkers}),
                                contentType: "application/json",
                                dataType: "json",

                                success: function (response) {
                                    {#alert("Sucesso");#}
                                    var uri = 'data:text/csv;charset=UTF-8,' + encodeURIComponent(response);
                                    var link = document.createElement('a');
                                    link.download = 'route.csv';
                                    link.href = uri;

                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                },
                                error: function (response) {
                                    alert("Erro");
                                }
                            });
                    }
                }
            ]
        });

        var selectButton = L.easyButton({
            states:[
                {
                    icon: "<i class='fa-solid fa-map-location-dot'></i> " + "{{ _('Selecionar') }}",
                    stateName: 'select',
                    width: '100%',
                    title: selectTooltip,
                    onClick: function(btn, map){
                        btn.state('unselect');
                        toggle_select = !toggle_select;
                        saveSelectButton.addTo(map);
                        console.log(toggle_select);
                    }
                },
                {
                    icon: "<i class='fa-solid fa-map-location-dot''></i> " + "{{ _('Selecionar') }}",
                    stateName: 'unselect',
                    width: '100%',
                    title: unselectTooltip,
                    onClick: function(btn, map){
                        btn.state('select');
                        markers_selected.eachLayer(function (marker){
                            if(marker.getIcon() === greenblueIcon) {
                                marker.setIcon(greenIcon);
                            }
                            else if (marker.getIcon() === redblueIcon) {
                                marker.setIcon(redIcon);
                            }
                        });
                        toggle_select = !toggle_select;
                        saveSelectButton.remove();
                        console.log(toggle_select);
                    }
                },
            ]
        }).addTo(map);

        function markerOnClick (e) {
            if (toggle_select) {
                e.target.closePopup();
                if(e.target.getIcon() === greenIcon) {
                    e.target.setIcon(greenblueIcon);
                    e.target.addTo(markers_selected);
                }
                else if(e.target.getIcon() === greenblueIcon) {
                    e.target.setIcon(greenIcon);
                    e.target.removeFrom(markers_selected);
                }
                else if (e.target.getIcon() === redIcon) {
                    e.target.setIcon(redblueIcon);
                    e.target.addTo(markers_selected);
                }
                else {
                    e.target.setIcon(redIcon);
                    e.target.removeFrom(markers_selected);
                }
                map.removeLayer(markers_selected);
            }
            else {}
        }

        // Actions
        function removeOtherLayers(target_layer) {
            $.each([P1442, P1766, P18, P1801, P3311, P3451, P4291, P4640, P5252, P5775, P8517, P8592, P9721, P9906], function (index, layer) {
                map.removeLayer(layer);
            });
            map.addLayer(target_layer);
        }

        function removeThisLayer(target_layer){
            $.each([P1442, P1766, P18, P1801, P3311, P3451, P4291, P4640, P5252, P5775, P8517, P8592, P9721, P9906], function (index, layer) {
                map.addLayer(layer);
            });
            map.removeLayer(target_layer);
        }

        $('#filter').on('click', function (event) {
            // HAS IMAGE
            var has_image = $('#has_image').val();

            // TYPES
            var types = $('#types').val();

            if (has_image === "yes") {
                map.removeLayer(markers_without_image);
                map.addLayer(markers_with_image);
                if (types === "all") {
                    $.each([P1442, P1766, P18, P1801, P3311, P3451, P4291, P4640, P5252, P5775, P8517, P8592, P9721, P9906], function (index, layer) {
                        map.addLayer(layer);
                    });
                }
                else if (types === "P1442") { removeOtherLayers(P1442); }
                else if (types === "P1766") { removeOtherLayers(P1766); }
                else if (types === "P18") { removeOtherLayers(P18); }
                else if (types === "P1801") { removeOtherLayers(P1801); }
                else if (types === "P3311") { removeOtherLayers(P3311); }
                else if (types === "P3451") { removeOtherLayers(P3451); }
                else if (types === "P4291") { removeOtherLayers(P4291); }
                else if (types === "P4640") { removeOtherLayers(P4640); }
                else if (types === "P5252") { removeOtherLayers(P5252); }
                else if (types === "P5775") { removeOtherLayers(P5775); }
                else if (types === "P8517") { removeOtherLayers(P8517); }
                else if (types === "P8592") { removeOtherLayers(P8592); }
                else if (types === "P9721") { removeOtherLayers(P9721); }
                else if (types === "P9906") { removeOtherLayers(P9906); }
            }
            else if (has_image === "no") {
                map.addLayer(markers_without_image);
                map.addLayer(markers_with_image);
                if (types === "all") {
                    $.each([P1442, P1766, P18, P1801, P3311, P3451, P4291, P4640, P5252, P5775, P8517, P8592, P9721, P9906], function (index, layer) {
                        map.removeLayer(layer);
                    });
                }
                else if (types === "P1442") { removeThisLayer(P1442); }
                else if (types === "P1766") { removeThisLayer(P1766); }
                else if (types === "P18") { removeThisLayer(P18); }
                else if (types === "P1801") { removeThisLayer(P1801); }
                else if (types === "P3311") { removeThisLayer(P3311); }
                else if (types === "P3451") { removeThisLayer(P3451); }
                else if (types === "P4291") { removeThisLayer(P4291); }
                else if (types === "P4640") { removeThisLayer(P4640); }
                else if (types === "P5252") { removeThisLayer(P5252); }
                else if (types === "P5775") { removeThisLayer(P5775); }
                else if (types === "P8517") { removeThisLayer(P8517); }
                else if (types === "P8592") { removeThisLayer(P8592); }
                else if (types === "P9721") { removeThisLayer(P9721); }
                else if (types === "P9906") { removeThisLayer(P9906); }
            }
            else {
                map.addLayer(markers_without_image);
                map.addLayer(markers_with_image);
                $.each([P1442, P1766, P18, P1801, P3311, P3451, P4291, P4640, P5252, P5775, P8517, P8592, P9721, P9906, markers_without_image], function (index, layer) {
                    map.addLayer(layer);
                });
            }

            has_image_filtered = has_image;
            types_filtered = types;
        });

        $('#has_image').on('change', function () {
            if (this.value === "all") {
                $('#types').prop("disabled", true);
            } else {
                $('#types').prop("disabled", false);
                $('#types option[value="all"]').prop("selected", true);
            }
        })

        var P1442=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P1766=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P18=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P1801=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P3311=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P3451=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P4291=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P4640=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P5252=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P5775=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P8517=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P8592=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P9721=L.featureGroup.subGroup(markers_with_image).addTo(map),
            P9906=L.featureGroup.subGroup(markers_with_image).addTo(map);

        {{markers|safe}}
    </script>
    <script src="{{ url_for('static', filename='js/state-monuments.js') }}"></script>
{% endblock %}